<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chess-AI-App Fun with Chess</title>
  <link rel="stylesheet" href="chessboard.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #auth-container {
      max-width: 400px;
      margin: 50px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    header {
      background-color: #333;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
    }
    .main-container {
      display: flex;
      height: calc(100vh - 60px);
    }
    .chessboard-section {
      flex: 1;
      padding: 20px;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .game-panel {
      flex: 1.5;
      padding: 20px;
      background-color: #f9f9f9;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }
    /* Grid layout - remove to make tab-panel full width */
    .panel-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .panel-grid .section-box {
      margin-bottom: 0;
    }
    
    /* New grid layout for Strategy + TabPanel side by side */
    .game-content-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 20px;
    }
    
    .game-content-grid .section-box {
      margin-bottom: 0;
    }
    
    /* TabPanel styling - now half width */
    .tab-panel {
      display: flex;
      flex-direction: column;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: white;
      overflow: hidden;
    }
    .tab-panel-list {
      display: flex;
      border-bottom: 2px solid #333;
      background-color: #f5f5f5;
    }
    .tab-panel-button {
      flex: 1;
      padding: 12px;
      cursor: pointer;
      border: none;
      background: #f5f5f5;
      font-size: 0.95em;
      font-weight: 500;
      transition: all 0.2s ease;
      outline: none;
    }
    .tab-panel-button:hover {
      background-color: #efefef;
    }
    .tab-panel-button.active {
      background-color: white;
      border-bottom: 3px solid #2196F3;
      margin-bottom: -2px;
      color: #2196F3;
    }
    .tab-panel-content {
      padding: 15px;
      flex: 1;
      overflow-y: auto;
    }
    /* Move history styling */
    #move-history {
      min-height: 120px;
      font-size: 0.95em;
      line-height: 1.6;
    }
    #move-history div {
      padding: 4px 0;
    }
    /* Expert section styling */
    .expert-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    #expert-input {
      flex: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9em;
    }
    .expert-send-btn {
      padding: 8px 16px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      transition: background-color 0.2s ease;
    }
    .expert-send-btn:hover {
      background-color: #1976D2;
    }
    #expert-response {
      min-height: 80px;
      padding: 10px;
      background-color: #f5f5f5;
      border-radius: 4px;
      font-size: 0.9em;
      line-height: 1.5;
      overflow-y: auto;
    }
    /* Make Strategy panel span full width */
    .strategy-box {
      grid-column: 1 / -1;
    }
    /* Make FEN panel span full width */
    .fen-box {
      grid-column: 1 / -1;
    }
    .section-box {
      padding: 15px;
      background-color: white;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    #board {
      width: 400px;
      height: 400px;
      margin: 0 auto;
    }
    #status-box {
      width: 400px;
      margin: 15px auto;
      padding: 12px;
      background-color: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: monospace;
      font-size: 14px;
      min-height: 60px;
      max-height: 120px;
      overflow-y: auto;
    }
    #status-box .status-success {
      color: #2e7d32;
    }
    #status-box .status-error {
      color: #c62828;
    }
    #status-box .status-info {
      color: #1565c0;
    }
    #status-box .status-time {
      color: #757575;
      font-size: 12px;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
    }
    .btn-primary {
      background-color: #4CAF50;
      color: white;
      width: 100%;
    }
    .btn-primary:hover {
      background-color: #45a049;
    }
    .btn-danger {
      background-color: #f44336;
      color: white;
      padding: 8px 16px;
    }
    .btn-danger:hover {
      background-color: #da190b;
    }
    #fen-display {
      background-color: #f5f5f5;
      padding: 10px;
      border-radius: 4px;
      word-break: break-all;
      font-family: monospace;
      font-size: 12px;
      max-height: 80px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="chessboard.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
  
  <script>
    let authToken = null;
    let currentUser = null;
    let board = null;
      let game = null;
      let moveHistory = [];

    function checkAuthentication() {
      const token = localStorage.getItem('authToken');
      const user = localStorage.getItem('currentUser');

      if (!token) {
        showLoginInterface();
        return;
      }

      authToken = token;
      currentUser = user;
      verifyToken(token);
    }

    function showLoginInterface() {
      const loginHTML = `
        <div id="auth-container">
          <h2>Chess AI App</h2>
          <div id="auth-form">
            <h3>Login</h3>
            <input id="login-username" type="text" placeholder="Username" style="width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box;">
            <input id="login-password" type="password" placeholder="Password" style="width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box;">
            <div id="login-error" style="color: red; margin: 10px 0; display: none;"></div>
            <button onclick="handleLogin()" style="width: 100%; padding: 10px; margin: 10px 0; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Login</button>
            <button onclick="switchToRegister()" style="width: 100%; padding: 10px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Register</button>
          </div>
        </div>
      `;
      document.getElementById('app').innerHTML = loginHTML;
    }

      function switchToRegister() {
        const registerHTML = `
        <div id="auth-container">
          <h2>Chess AI App</h2>
          <div id="auth-form">
            <h3>Register</h3>
            <input id="register-username" type="text" placeholder="Username" style="width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box;">
            <input id="register-email" type="email" placeholder="Email" style="width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box;">
            <input id="register-password" type="password" placeholder="Password" style="width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box;">
            <div id="register-error" style="color: red; margin: 10px 0; display: none;"></div>
            <button onclick="handleRegister()" style="width: 100%; padding: 10px; margin: 10px 0; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Register</button>
            <button onclick="showLoginInterface()" style="width: 100%; padding: 10px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Back to Login</button>
          </div>
        </div>
      `;
      document.getElementById('app').innerHTML = registerHTML;
    }

      function handleLogin() {
        const username = document.getElementById('login-username').value;
        const password = document.getElementById('login-password').value;
        const errorDiv = document.getElementById('login-error');

      if (!username || !password) {
        errorDiv.textContent = 'Please enter username and password';
        errorDiv.style.display = 'block';
        return;
      }

      fetch('http://localhost:8002/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.token) {
            authToken = data.token;
            currentUser = username;
            localStorage.setItem('authToken', authToken);
            localStorage.setItem('currentUser', currentUser);
            localStorage.setItem('isAdmin', data.is_admin ? 'true' : 'false');

            if (data.is_admin) {
              window.location.href = 'admin.html';
            } else {
              loadChessboardInterface();
            }
          } else {
            errorDiv.textContent = data.detail || data.message || 'Login failed';
            errorDiv.style.display = 'block';
          }
        })
        .catch(error => {
          errorDiv.textContent = 'Error: ' + error.message;
          errorDiv.style.display = 'block';
        });
    }

      function handleRegister() {
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const errorDiv = document.getElementById('register-error');

      if (!username || !email || !password) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.style.display = 'block';
        return;
      }

      fetch('http://localhost:8002/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, email, password })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Registration successful! Please login.');
            showLoginInterface();
          } else {
            errorDiv.textContent = data.detail || data.message || 'Registration failed';
            errorDiv.style.display = 'block';
          }
        })
        .catch(error => {
          errorDiv.textContent = 'Error: ' + error.message;
          errorDiv.style.display = 'block';
        });
    }

      function verifyToken(token) {
      fetch('http://localhost:8002/auth/verify', {
        method: 'POST',
        headers: { 'Authorization': 'Bearer ' + token }
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            currentUser = data.username;
            localStorage.setItem('isAdmin', data.is_admin ? 'true' : 'false');

            if (data.is_admin) {
              window.location.href = 'admin.html';
            } else {
              loadChessboardInterface();
            }
          } else {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            localStorage.removeItem('isAdmin');
            showLoginInterface();
          }
        })
        .catch(() => {
          localStorage.removeItem('authToken');
          localStorage.removeItem('currentUser');
          localStorage.removeItem('isAdmin');
          showLoginInterface();
        });
    }

      function updateStatusBox(message, type = 'info') {
        const statusBox = document.getElementById('status-box');
        if (!statusBox) return;

        const timestamp = new Date().toLocaleTimeString();
        const statusClass = `status-${type}`;

        const newMessage = `<div><span class="status-time">[${timestamp}]</span> <span class="${statusClass}">${message}</span></div>`;

        statusBox.innerHTML = newMessage + statusBox.innerHTML;

        const messages = statusBox.querySelectorAll('div');
        if (messages.length > 10) {
          for (let i = 10; i < messages.length; i++) {
            messages[i].remove();
          }
        }
      }

      function updateMoveHistory(move, isAI = false) {
        const player = isAI ? 'AI' : 'You';
        moveHistory.push({ move, player });

        const historyDiv = document.getElementById('move-history');
        if (historyDiv) {
          let html = '';
          for (let i = 0; i < moveHistory.length; i += 2) {
            const moveNum = Math.floor(i / 2) + 1;
            const whiteMove = moveHistory[i] ? `${moveHistory[i].player}: ${moveHistory[i].move}` : '';
            const blackMove = moveHistory[i + 1] ? `${moveHistory[i + 1].player}: ${moveHistory[i + 1].move}` : '';
            html += `<div>${moveNum}. ${whiteMove} ${blackMove}</div>`;
          }
          historyDiv.innerHTML = html || '<p style="color: #999;">No moves yet</p>';
        }
      }

                          function switchTab(tabName) {
                            // Hide all tab panels
                            document.querySelectorAll('.tab-panel-content').forEach(panel => {
                              panel.style.display = 'none';
                            });

                            // Remove active class from all buttons
                            document.querySelectorAll('.tab-panel-button').forEach(btn => {
                              btn.classList.remove('active');
                            });

                            // Show selected tab
                            const selectedPanel = document.getElementById(tabName);
                            if (selectedPanel) {
                              selectedPanel.style.display = 'block';
                            }

                            // Highlight active button
                            event.target.classList.add('active');
                          }

      function loadChessboardInterface() {
        const chessboardHTML = `
        <header>
          <h1>Chess AI App</h1>
          <div style="display: flex; gap: 15px; align-items: center;">
            <span>Welcome, <strong>${currentUser}</strong></span>
            <button onclick="handleLogout()" class="btn-danger">Logout</button>
          </div>
        </header>

        <div class="main-container">
          <div class="chessboard-section">
            <div id="board"></div>

            <!-- FEN Notation (Moved from game-panel to here) -->
            <div id="fen-notation-box" style="width: 400px; margin: 15px auto; padding: 10px; background-color: #f5f5f5; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;">
              <strong>FEN:</strong> <span id="fen-display">rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1</span>
            </div>
            
            <div id="game-status" style="margin-top: 10px; text-align: center; font-size: 16px;">
              <p>Game Status: <strong>Ready to play</strong></p>
            </div>
          </div>

          <div class="game-panel">
            <h2>Game Panel</h2>

            <!-- Grid Layout: Status box and TabPanel side by side -->
            <div class="game-content-grid">
              <!-- Status Box (Left) -->
              <div class="section-box">
                <h3>Game Log</h3>
                <div id="status-box-left">
                  <div><span class="status-time">[${new Date().toLocaleTimeString()}]</span> <span class="status-info">Ready to play. Start a new game or make a move.</span></div>
                </div>
              </div>

              <!-- TabPanel: Player Setup, Move History, Ask Expert & Strategy (Right) -->
              <div class="tab-panel">
                <div class="tab-panel-list">
                  <button class="tab-panel-button active" onclick="switchTab('player-setup-panel')">Player Setup</button>
                  <button class="tab-panel-button" onclick="switchTab('move-history-panel')">Move History</button>
                  <button class="tab-panel-button" onclick="switchTab('expert-panel')">Ask Expert</button>
                  <button class="tab-panel-button" onclick="switchTab('strategy-panel')">Strategy</button>
                </div>

                <!-- Player Setup Tab -->
                <div id="player-setup-panel" class="tab-panel-content" style="display: block;">
                  <h3 style="margin-top: 0;">Player Setup</h3>
                  <label style="display: block; margin: 10px 0;">
                    White Player:
                    <select id="white-player" style="width: 100%; padding: 5px;">
                      <option value="human">Human</option>
                      <option value="ai">AI</option>
                    </select>
                  </label>
                  <label style="display: block; margin: 10px 0;">
                    Black Player:
                    <select id="black-player" style="width: 100%; padding: 5px;">
                      <option value="human">Human</option>
                      <option value="ai" selected>AI</option>
                    </select>
                  </label>
                  <label style="display: block; margin: 10px 0;">
                    AI Type:
                    <select id="ai-type" style="width: 100%; padding: 5px;">
                      <option value="stockfish" selected>Stockfish</option>
                      <option value="openai">OpenAI GPT</option>
                      <option value="deepseek">DeepSeek</option>
                      <option value="claude">Claude</option>
                    </select>
                  </label>
                  <label style="display: block; margin: 10px 0;">
                    Skill Level (1-20):
                    <input type="number" id="skill-level" value="10" min="1" max="20" style="width: 100%; padding: 5px;">
                  </label>
                  <button onclick="startNewGame()" class="btn-primary">Start New Game</button>
                </div>

                <!-- Move History Tab -->
                <div id="move-history-panel" class="tab-panel-content">
                  <h3 style="margin-top: 0;">Move History</h3>
                  <div id="move-history">
                    <p style="color: #999;">No moves yet</p>
                  </div>
                </div>

                <!-- Expert Tab -->
                <div id="expert-panel" class="tab-panel-content">
                  <h3 style="margin-top: 0;">Ask Expert</h3>
                  <div class="expert-input-group">
                    <input id="expert-input" type="text" placeholder="Ask a chess question...">
                    <button class="expert-send-btn" onclick="askExpert()">Send</button>
                  </div>
                  <div id="expert-response">
                    <p style="color: #999;">Ask a question and get expert chess advice</p>
                  </div>
                </div>

                <!-- Strategy Tab -->
                <div id="strategy-panel" class="tab-panel-content">
                  <h3 style="margin-top: 0;">Strategy</h3>
                  <label style="display: block; margin: 10px 0;">
                    White Opening:
                    <select id="white-strategy" style="width: 100%; padding: 5px;">
                      <option value="">No Opening</option>
                      <option value="ruy-lopez">Ruy Lopez</option>
                      <option value="italian">Italian Game</option>
                    </select>
                  </label>
                  <label style="display: block; margin: 10px 0;">
                    Black Defense:
                    <select id="black-strategy" style="width: 100%; padding: 5px;">
                      <option value="">No Defense</option>
                      <option value="sicilian">Sicilian Defense</option>
                      <option value="french">French Defense</option>
                    </select>
                  </label>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('app').innerHTML = chessboardHTML;
      initializeChessboard();
    }

      function initializeChessboard() {
      game = new Chess();
      
      board = Chessboard('board', {
        draggable: true,
        position: 'start',
        pieceTheme: 'img/chesspieces/wikipedia/{piece}.png',
        onDragStart: onDragStart,
        onDrop: onDrop,
        onSnapEnd: onSnapEnd
      });

        console.log('Chessboard initialized for user:', currentUser);
        updateStatusBox('Chessboard initialized successfully', 'success');
        updateFenDisplay();
      }

          function onDragStart(source, piece, position, orientation) {
            if (game.game_over()) {
              updateStatusBox('Game is over!', 'error');
              return false;
            }

            if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
              (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
              return false;
            }

            return true;
          }

          function onDrop(source, target) {
            const move = game.move({
              from: source,
              to: target,
              promotion: 'q'
            });

            if (move === null) {
              updateStatusBox(`Invalid move: ${source} â†’ ${target}`, 'error');
              return 'snapback';
            }

            updateStatusBox(`You played: ${move.san}`, 'info');
            updateMoveHistory(move.san, false);
            updateFenDisplay();

            // Check if we need AI to respond
            const blackPlayer = document.getElementById('black-player').value;
            const whitePlayer = document.getElementById('white-player').value;
            const needsAI = (game.turn() === 'b' && blackPlayer === 'ai') ||
              (game.turn() === 'w' && whitePlayer === 'ai');

            // Send move to engine
            sendMoveToEngine(source + target, game.fen(), needsAI);

            checkGameStatus();
          }

                          function onSnapEnd() {
                            board.position(game.fen());
                          }

                          function updateFenDisplay() {
                            const fenDisplay = document.getElementById('fen-display');
                            if (fenDisplay && game) {
                              fenDisplay.textContent = game.fen();
                            }
                          }

                          function checkGameStatus() {
                            const statusDiv = document.getElementById('game-status');
                            let status = '';

                          if (game.in_checkmate()) {
                            status = game.turn() === 'w' ? 'Black wins by checkmate!' : 'White wins by checkmate!';
                            updateStatusBox(status, 'success');
                          } else if (game.in_draw()) {
                            status = 'Game drawn!';
                            updateStatusBox(status, 'info');
                          } else if (game.in_check()) {
                            status = game.turn() === 'w' ? 'White is in check' : 'Black is in check';
                            updateStatusBox(status, 'info');
                          } else {
                            status = game.turn() === 'w' ? "White's turn" : "Black's turn";
                          }

                          if (statusDiv) {
                            statusDiv.innerHTML = `<p>Game Status: <strong>${status}</strong></p>`;
                          }
                        }

      function startNewGame() {
        const whitePlayer = document.getElementById('white-player').value;
        const blackPlayer = document.getElementById('black-player').value;

      game = new Chess();
      moveHistory = [];

      if (board) {
        board.start();
      }

      document.getElementById('move-history').innerHTML = '<p style="color: #999;">No moves yet</p>';
      updateFenDisplay();
      checkGameStatus();
      updateStatusBox(`New game started: White=${whitePlayer}, Black=${blackPlayer}`, 'success');
    }

      function sendMoveToEngine(move, fen, requestAiMove) {
        const aiType = document.getElementById('ai-type').value;
        const skillLevel = parseInt(document.getElementById('skill-level').value) || 10;

        console.log('[UI] Sending to engine:', { move, fen, requestAiMove, aiType, skillLevel });
    
      fetch('http://localhost:8000/move', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + authToken
        },
        body: JSON.stringify({
          move: move, 
          fen: fen,
          request_ai_move: requestAiMove,
          ai_type: aiType,
          skill_level: skillLevel
        })
      })
        .then(response => {
          console.log('[UI] Response status:', response.status);
          if (response.status === 401) {
            updateStatusBox('Authentication failed. Please login again.', 'error');
            handleLogout();
            throw new Error('Unauthorized');
          }
          return response.json();
        })
        .then(data => {
          console.log('[UI] Response data:', data);

          if (data.error) {
            updateStatusBox(`Server error: ${data.error}`, 'error');
            return;
          }

          updateStatusBox(`Move confirmed by server`, 'success');

          // Handle AI move response
          if (data.ai_move) {
            console.log('[UI] AI move received:', data.ai_move);

            // Parse the AI move (format: "e7e5" or "e7e5q" for promotion)
            const from = data.ai_move.substring(0, 2);
            const to = data.ai_move.substring(2, 4);
            const promotion = data.ai_move.length > 4 ? data.ai_move[4] : undefined;

            console.log('[UI] Parsed AI move:', { from, to, promotion });

            // Apply the AI move to our local game
            const aiMoveResult = game.move({
              from: from,
              to: to,
              promotion: promotion || 'q'
            });

            console.log('[UI] AI move result:', aiMoveResult);

            if (aiMoveResult) {
              // Update the board display
              board.position(game.fen());

              // Update move history with SAN notation
              const sanMove = data.ai_move_san || aiMoveResult.san;
              updateMoveHistory(sanMove, true);
              updateFenDisplay();
              updateStatusBox(`AI played: ${sanMove} (${data.ai_type})`, 'info');
              checkGameStatus();
            } else {
              console.error('[UI] Failed to apply AI move:', data.ai_move);
              updateStatusBox(`Failed to apply AI move: ${data.ai_move}`, 'error');

              // Try to sync with server FEN
              if (data.fen) {
                game.load(data.fen);
                board.position(data.fen);
                updateFenDisplay();
                updateStatusBox(`Board synced with server`, 'info');
              }
            }
          }
        })
        .catch(error => {
          if (error.message !== 'Unauthorized') {
            console.error('[UI] Error:', error);
            updateStatusBox(`Connection error: ${error.message}`, 'error');
          }
        });
    }

      function askExpert() {
        const question = document.getElementById('expert-input').value;
      if (!question) {
        updateStatusBox('Please enter a question', 'error');
        return;
      }

      updateStatusBox(`Asking expert: "${question}"`, 'info');

      fetch('http://localhost:8000/expert/question', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + authToken
        },
        body: JSON.stringify({ question: question, fen: game.fen() })
      })
        .then(response => {
          if (response.status === 401) {
            updateStatusBox('Authentication failed. Please login again.', 'error');
            handleLogout();
            throw new Error('Unauthorized');
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            document.getElementById('expert-response').textContent = 'Error: ' + data.error;
            updateStatusBox(`Expert error: ${data.error}`, 'error');
          } else {
            document.getElementById('expert-response').innerHTML = data.response || 'No response';
            document.getElementById('expert-input').value = '';
            updateStatusBox('Expert response received', 'success');
          }
        })
        .catch(error => {
          if (error.message !== 'Unauthorized') {
            document.getElementById('expert-response').textContent = 'Error: ' + error.message;
            updateStatusBox(`Expert connection error: ${error.message}`, 'error');
          }
        });
    }

      function handleLogout() {
        if (confirm('Are you sure you want to logout?')) {
          fetch('http://localhost:8002/auth/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: authToken })
          })
            .then(() => {
              authToken = null;
              currentUser = null;
              localStorage.removeItem('authToken');
              localStorage.removeItem('currentUser');
              localStorage.removeItem('isAdmin');
              showLoginInterface();
            })
            .catch(error => console.error('Logout error:', error));
        }
      }

      window.onload = checkAuthentication;
  </script>
</body>
</html>
