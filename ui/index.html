<!DOCTYPE html>
<html>
<head>
  <title>Chess-AI-App Fun with Chess</title>
  <link rel="stylesheet" href="chessboard.css">
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #auth-container {
      max-width: 400px;
      margin: 50px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    header {
      background-color: #333;
      color: white;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      margin: 0;
    }
    .main-container {
      display: flex;
      height: calc(100vh - 60px);
    }
    .chessboard-section {
      flex: 2;
      padding: 20px;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
    }
    .game-panel {
      flex: 1;
      padding: 20px;
      background-color: #f9f9f9;
      overflow-y: auto;
    }
    #board {
      width: 400px;
      height: 400px;
      margin: 0 auto;
    }
    .tab-buttons {
      display: flex;
      border-bottom: 1px solid #ccc;
      margin-bottom: 10px;
    }
    .tab-btn {
      flex: 1;
      padding: 10px;
      cursor: pointer;
      background: #eee;
      border: none;
      border-right: 1px solid #ccc;
      font-size: 0.9em;
      outline: none;
    }
    .tab-btn.active {
      background: white;
      font-weight: bold;
      border-bottom: 2px solid #333;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .section-box {
      margin-bottom: 20px;
      padding: 15px;
      background-color: white;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    button {
      padding: 10px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1em;
    }
    .btn-primary {
      background-color: #4CAF50;
      color: white;
      width: 100%;
    }
    .btn-primary:hover {
      background-color: #45a049;
    }
    .btn-danger {
      background-color: #f44336;
      color: white;
      padding: 8px 16px;
    }
    .btn-danger:hover {
      background-color: #da190b;
    }
    .logout-btn {
      background-color: #f44336;
      color: white;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="chessboard.js"></script>
  
  <script>
    let authToken = null;
    let currentUser = null;
    let board = null;

    function checkAuthentication() {
      const token = localStorage.getItem('authToken');
      if (token) {
        authToken = token;
        verifyToken(token);
      } else {
        showLoginInterface();
      }
    }

    function showLoginInterface() {
      const loginHTML = `
          <div id="auth-container">
            <h2>Chess AI App</h2>
            <div id="auth-form">
              <h3>Login</h3>
              <input id="login-username" type="text" placeholder="Username" style="width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box;">
              <input id="login-password" type="password" placeholder="Password" style="width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box;">
              <div id="login-error" style="color: red; margin: 10px 0; display: none;"></div>
              <button onclick="handleLogin()" style="width: 100%; padding: 10px; margin: 10px 0; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Login</button>
              <button onclick="switchToRegister()" style="width: 100%; padding: 10px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Register</button>
            </div>
          </div>
      `;
          document.getElementById('app').innerHTML = loginHTML;
        }

        function switchToRegister() {
          const registerHTML = `
        <div id="auth-container">
          <h2>Chess AI App</h2>
          <div id="auth-form">
            <h3>Register</h3>
            <input id="register-username" type="text" placeholder="Username" style="width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box;">
            <input id="register-email" type="email" placeholder="Email" style="width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box;">
            <input id="register-password" type="password" placeholder="Password" style="width: 100%; padding: 8px; margin: 5px 0; box-sizing: border-box;">
            <div id="register-error" style="color: red; margin: 10px 0; display: none;"></div>
            <button onclick="handleRegister()" style="width: 100%; padding: 10px; margin: 10px 0; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">Register</button>
            <button onclick="showLoginInterface()" style="width: 100%; padding: 10px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Back to Login</button>
          </div>
        </div>
      `;
      document.getElementById('app').innerHTML = registerHTML;
    }

  function handleLogin() {
    const username = document.getElementById('login-username').value;
    const password = document.getElementById('login-password').value;
    const errorDiv = document.getElementById('login-error');

      if (!username || !password) {
        errorDiv.textContent = 'Please enter username and password';
        errorDiv.style.display = 'block';
        return;
      }

      fetch('http://localhost:8000/auth/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success && data.token) {
            authToken = data.token;
            currentUser = username;
            localStorage.setItem('authToken', authToken);
            localStorage.setItem('currentUser', currentUser);
            loadChessboardInterface();
          } else {
            errorDiv.textContent = data.message || 'Login failed';
            errorDiv.style.display = 'block';
          }
        })
        .catch(error => {
          errorDiv.textContent = 'Error: ' + error.message;
          errorDiv.style.display = 'block';
        });
    }

      function handleRegister() {
        const username = document.getElementById('register-username').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const errorDiv = document.getElementById('register-error');

      if (!username || !email || !password) {
        errorDiv.textContent = 'Please fill in all fields';
        errorDiv.style.display = 'block';
        return;
      }

      fetch('http://localhost:8000/auth/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, email, password })
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert('Registration successful! Please login.');
            showLoginInterface();
          } else {
            errorDiv.textContent = data.message || 'Registration failed';
            errorDiv.style.display = 'block';
          }
        })
        .catch(error => {
          errorDiv.textContent = 'Error: ' + error.message;
          errorDiv.style.display = 'block';
        });
    }

      function verifyToken(token) {
        fetch('http://localhost:8000/auth/verify', {
          headers: { 'Authorization': 'Bearer ' + token }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              currentUser = data.username;
              loadChessboardInterface();
            } else {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            showLoginInterface();
          }
        })
        .catch(() => {
          localStorage.removeItem('authToken');
          localStorage.removeItem('currentUser');
          showLoginInterface();
        });
    }

      function loadChessboardInterface() {
        const chessboardHTML = `
        <header>
          <h1>Chess AI App</h1>
          <div style="display: flex; gap: 15px; align-items: center;">
            <span>Welcome, <strong>${currentUser}</strong></span>
            <button onclick="handleLogout()" class="btn-danger">Logout</button>
          </div>
        </header>

        <div class="main-container">
          <!-- Chessboard Section -->
          <div class="chessboard-section">
            <div id="board"></div>
            <div id="game-status" style="margin-top: 20px; text-align: center; font-size: 16px;">
              <p>Game Status: <strong>Ready to play</strong></p>
            </div>
          </div>

          <!-- Game Panel Section -->
          <div class="game-panel">
            <h2>Game Panel</h2>

            <!-- Player Setup -->
            <div class="section-box">
              <h3>Player Setup</h3>
              <label style="display: block; margin: 10px 0;">
                White Player:
                <select id="white-player" style="width: 100%; padding: 5px;">
                  <option value="human">Human</option>
                  <option value="ai">AI</option>
                </select>
              </label>
              <label style="display: block; margin: 10px 0;">
                Black Player:
                <select id="black-player" style="width: 100%; padding: 5px;">
                  <option value="human">Human</option>
                  <option value="ai" selected>AI</option>
                </select>
              </label>
              <button onclick="startNewGame()" class="btn-primary">Start New Game</button>
            </div>

            <!-- Strategy Selection -->
            <div class="section-box">
              <h3>Strategy</h3>
              <label style="display: block; margin: 10px 0;">
                White Opening:
                <select id="white-strategy" style="width: 100%; padding: 5px;">
                  <option value="">No Opening</option>
                  <option value="ruy-lopez">Ruy Lopez</option>
                  <option value="italian">Italian Game</option>
                </select>
              </label>
              <label style="display: block; margin: 10px 0;">
                Black Defense:
                <select id="black-strategy" style="width: 100%; padding: 5px;">
                  <option value="">No Defense</option>
                  <option value="sicilian">Sicilian Defense</option>
                  <option value="french">French Defense</option>
                </select>
              </label>
            </div>

            <!-- Tabs for Move History and Expert -->
            <div class="section-box">
              <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab(event, 'moves-tab')">Move History</button>
                <button class="tab-btn" onclick="switchTab(event, 'expert-tab')">Expert</button>
              </div>

              <div id="moves-tab" class="tab-content active">
                <div id="move-history" style="height: 150px; overflow-y: auto; background-color: #f5f5f5; padding: 10px; border-radius: 4px;">
                  <p style="color: #999;">No moves yet</p>
                </div>
              </div>

              <div id="expert-tab" class="tab-content">
                <input id="expert-input" type="text" placeholder="Ask a chess question..." style="width: 100%; padding: 8px; margin-bottom: 10px; box-sizing: border-box;">
                <button onclick="askExpert()" style="width: 100%; padding: 8px; background-color: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer;">Send</button>
                <div id="expert-response" style="margin-top: 10px; padding: 10px; background-color: #f5f5f5; border-radius: 4px; min-height: 50px;"></div>
              </div>
            </div>

            <!-- FEN Display -->
            <div class="section-box">
              <h3>FEN Notation</h3>
              <div id="fen-display" style="background-color: #f5f5f5; padding: 10px; border-radius: 4px; word-break: break-all; font-family: monospace; font-size: 12px;">
                rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1
              </div>
            </div>
          </div>
        </div>
      `;

      document.getElementById('app').innerHTML = chessboardHTML;
      initializeChessboard();
    }

      function initializeChessboard() {
        board = Chessboard('board', {
          draggable: true,
          onDrop: function (source, target, piece, newPos, oldPos, orientation) {
            const move = source + '-' + target;
            const fen = board.fen();
            sendMoveToEngine(move, fen);
            return 'snapback';
          }
        });
        console.log('Chessboard initialized for user:', currentUser);
      }

      function startNewGame() {
        const whitePlayer = document.getElementById('white-player').value;
        const blackPlayer = document.getElementById('black-player').value;
        console.log(`Starting game: White=${whitePlayer}, Black=${blackPlayer}`);
        if (board) {
          board.start();
          document.getElementById('fen-display').textContent = board.fen();
          document.getElementById('game-status').innerHTML = '<p>Game Status: <strong>Game Started</strong></p>';
        }
    }

    function sendMoveToEngine(move, fen) {
      fetch('http://localhost:8000/move', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ move: move, fen: fen })
      })
        .then(response => response.json())
        .then(data => {
          if (board) {
            board.position(data.fen);
            document.getElementById('fen-display').textContent = data.fen;
            document.getElementById('game-status').innerHTML = `<p>Game Status: <strong>${data.status}</strong></p>`;
          }
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('game-status').innerHTML = `<p>Game Status: <strong>Error: ${error.message}</strong></p>`;
        });
    }

      function switchTab(event, tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        event.target.classList.add('active');
      }

      function askExpert() {
        const question = document.getElementById('expert-input').value;
        if (!question) return;

      fetch('http://localhost:8000/expert/question', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question: question })
      })
        .then(response => response.json())
        .then(data => {
          document.getElementById('expert-response').textContent = data.response || 'No response';
          document.getElementById('expert-input').value = '';
        })
        .catch(error => {
          document.getElementById('expert-response').textContent = 'Error: ' + error.message;
        });
    }

      function handleLogout() {
        if (confirm('Are you sure you want to logout?')) {
          fetch('http://localhost:8000/auth/logout', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ token: authToken })
          })
            .then(() => {
              authToken = null;
              currentUser = null;
              localStorage.removeItem('authToken');
              localStorage.removeItem('currentUser');
              showLoginInterface();
            })
            .catch(error => console.error('Logout error:', error));
        }
      }

      window.onload = checkAuthentication;
  </script>
</body>
</html>
